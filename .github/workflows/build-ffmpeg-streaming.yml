name: Build FFmpeg with Streaming Support

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build-linux:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup environment
      run: |
        BUILD_DIR="$GITHUB_WORKSPACE/ffmpeg-build-linux"
        echo "BUILD_DIR=$BUILD_DIR" >> $GITHUB_ENV
        mkdir -p "$BUILD_DIR"
        echo "Build directory: $BUILD_DIR"

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          nasm \
          yasm \
          git \
          pkg-config \
          cmake \
          zlib1g-dev \
          libssl-dev \
          libx264-dev \
          libmp3lame-dev \
          libopus-dev \
          libwebp-dev \
          wget \
          tar

    - name: Clone FFmpeg
      run: |
        git clone --depth 1 https://git.ffmpeg.org/ffmpeg.git ffmpeg-src

    - name: Configure FFmpeg
      run: |
        cd ffmpeg-src
        ./configure \
          --prefix="$BUILD_DIR" \
          --enable-gpl \
          --enable-version3 \
          --enable-nonfree \
          --enable-libx264 \
          --enable-libmp3lame \
          --enable-libopus \
          --enable-libwebp \
          --enable-shared \
          --enable-demuxer=mpegts \
          --enable-parser=mpegts \
          --enable-muxer=mpegts \
          --enable-protocol=file \
          --enable-protocol=http \
          --enable-protocol=https \
          --enable-protocol=hls \
          --enable-protocol=dash \
          --enable-protocol=rtmp \
          --enable-protocol=rtmps \
          --enable-protocol=srt \
          --enable-protocol=udp \
          --enable-protocol=tcp \
          --enable-protocol=sctp \
          --enable-filter=insert_scte35 \
          --enable-filter=remove_scte35

    - name: Build FFmpeg
      run: |
        cd ffmpeg-src
        make -j$(nproc)
        make install

    - name: Verify build
      run: |
        if [ -f "$BUILD_DIR/bin/ffmpeg" ]; then
          "$BUILD_DIR/bin/ffmpeg" -version | head -2
          echo "✅ Linux build successful!"
          
          # Verify SCTE-35 support
          echo "Checking SCTE-35 support..."
          if "$BUILD_DIR/bin/ffmpeg" -filters 2>&1 | grep -q "scte35"; then
            echo "✅ SCTE-35 filters available"
            "$BUILD_DIR/bin/ffmpeg" -filters 2>&1 | grep "scte35"
          else
            echo "⚠️ SCTE-35 filters not found"
          fi
        else
          echo "❌ Linux build failed"
          exit 1
        fi

    - name: Upload Linux artifact
      uses: actions/upload-artifact@v4
      with:
        name: ffmpeg-linux
        path: ${{ env.BUILD_DIR }}/bin/ffmpeg

  build-windows:
    runs-on: windows-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup environment
      run: |
        $buildDir = "$pwd\ffmpeg-build-windows"
        echo "BUILD_DIR=$buildDir" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
        New-Item -ItemType Directory -Path $buildDir -Force
        Write-Host "Build directory: $buildDir"

    - name: Download pre-built FFmpeg
      run: |
        # Download pre-built FFmpeg for Windows with streaming support
        $ffmpegUrl = "https://github.com/BtbN/FFmpeg-Builds/releases/download/latest/ffmpeg-master-latest-win64-gpl.zip"
        $zipPath = "ffmpeg-windows.zip"
        
        Write-Host "Downloading pre-built FFmpeg..."
        Invoke-WebRequest -Uri $ffmpegUrl -OutFile $zipPath
        
        Write-Host "Extracting FFmpeg..."
        Expand-Archive -Path $zipPath -DestinationPath "ffmpeg-extracted" -Force
        
        # Find and copy the ffmpeg.exe
        $ffmpegExe = Get-ChildItem -Path "ffmpeg-extracted" -Recurse -Name "ffmpeg.exe" | Select-Object -First 1
        if ($ffmpegExe) {
            $sourcePath = "ffmpeg-extracted\$ffmpegExe"
            $destPath = "$env:BUILD_DIR\bin\ffmpeg.exe"
            New-Item -ItemType Directory -Path "$env:BUILD_DIR\bin" -Force
            Copy-Item -Path $sourcePath -Destination $destPath -Force
            Write-Host "✅ FFmpeg copied to $destPath"
        } else {
            Write-Host "❌ Could not find ffmpeg.exe in extracted files"
            exit 1
        }

    - name: Verify build
      run: |
        if (Test-Path "$env:BUILD_DIR\bin\ffmpeg.exe") {
          & "$env:BUILD_DIR\bin\ffmpeg.exe" -version | Select-Object -First 2
          Write-Host "✅ Windows build successful!"
          
          # Verify SCTE-35 support
          Write-Host "Checking SCTE-35 support..."
          $scte35Check = & "$env:BUILD_DIR\bin\ffmpeg.exe" -filters 2>&1 | Select-String "scte35"
          if ($scte35Check) {
            Write-Host "✅ SCTE-35 filters available: $scte35Check"
          } else {
            Write-Host "⚠️ SCTE-35 filters not found in pre-built binary"
          }
        } else {
          Write-Host "❌ Windows build failed"
          Write-Host "Build directory contents:"
          Get-ChildItem "$env:BUILD_DIR" -Recurse | ForEach-Object { $_.FullName }
          exit 1
        }

    - name: Upload Windows artifact
      uses: actions/upload-artifact@v4
      with:
        name: ffmpeg-windows
        path: ${{ env.BUILD_DIR }}/bin/ffmpeg.exe

  build-macos:
    runs-on: macos-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup environment
      run: |
        BUILD_DIR="$GITHUB_WORKSPACE/ffmpeg-build-macos"
        echo "BUILD_DIR=$BUILD_DIR" >> $GITHUB_ENV
        mkdir -p "$BUILD_DIR"
        echo "Build directory: $BUILD_DIR"

    - name: Install dependencies
      run: |
        brew update
        # Handle cmake conflict - uninstall if from local tap, then install from core
        brew list cmake >/dev/null 2>&1 && brew uninstall cmake || true
        # Install build tools
        brew install nasm yasm pkg-config cmake
        # Install codec libraries
        brew install x264 lame opus webp
        # Verify installations
        echo "Installed packages:"
        brew list | grep -E "(nasm|yasm|pkg-config|cmake|x264|lame|opus|webp)" || true

    - name: Clone FFmpeg
      run: |
        git clone --depth 1 https://git.ffmpeg.org/ffmpeg.git ffmpeg-src

    - name: Configure FFmpeg for macOS
      run: |
        cd ffmpeg-src
        # macOS-specific configuration with proper library paths
        ./configure \
          --prefix="$BUILD_DIR" \
          --enable-gpl \
          --enable-version3 \
          --enable-nonfree \
          --enable-libx264 \
          --enable-libmp3lame \
          --enable-libopus \
          --enable-libwebp \
          --enable-shared \
          --enable-demuxer=mpegts \
          --enable-parser=mpegts \
          --enable-muxer=mpegts \
          --enable-protocol=file \
          --enable-protocol=http \
          --enable-protocol=https \
          --enable-protocol=hls \
          --enable-protocol=dash \
          --enable-protocol=rtmp \
          --enable-protocol=rtmps \
          --enable-protocol=srt \
          --enable-protocol=udp \
          --enable-protocol=tcp \
          --enable-protocol=sctp \
          --enable-filter=insert_scte35 \
          --enable-filter=remove_scte35 \
          --extra-cflags="-I$(brew --prefix)/include" \
          --extra-ldflags="-L$(brew --prefix)/lib"
        
        # Show configuration summary
        echo "=== FFmpeg Configuration Summary ==="
        grep -E "(libx264|libmp3lame|libopus|libwebp)" config.log || echo "Some libraries may not be detected"
        echo "==================================="

    - name: Build FFmpeg
      run: |
        cd ffmpeg-src
        make -j$(sysctl -n hw.ncpu)
        make install

    - name: Verify build
      run: |
        if [ -f "$BUILD_DIR/bin/ffmpeg" ]; then
          "$BUILD_DIR/bin/ffmpeg" -version | head -2
          echo "✅ macOS build successful!"
          
          # Verify SCTE-35 support
          echo "Checking SCTE-35 support..."
          if "$BUILD_DIR/bin/ffmpeg" -filters 2>&1 | grep -q "scte35"; then
            echo "✅ SCTE-35 filters available"
            "$BUILD_DIR/bin/ffmpeg" -filters 2>&1 | grep "scte35"
          else
            echo "⚠️ SCTE-35 filters not found"
          fi
        else
          echo "❌ macOS build failed"
          echo "Build directory contents:"
          ls -la "$BUILD_DIR/" || true
          echo "FFmpeg source directory:"
          ls -la ffmpeg-src/ || true
          exit 1
        fi

    - name: Upload macOS artifact
      uses: actions/upload-artifact@v4
      with:
        name: ffmpeg-macos
        path: ${{ env.BUILD_DIR }}/bin/ffmpeg

  report-status:
    runs-on: ubuntu-latest
    needs: [build-linux, build-windows, build-macos]
    if: always()
    steps:
    - name: Build status report
      run: |
        echo "=== BUILD STATUS REPORT ==="
        echo "Linux: ${{ needs.build-linux.result }}"
        echo "Windows: ${{ needs.build-windows.result }}"
        echo "macOS: ${{ needs.build-macos.result }}"
        echo "==========================="
